<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h2 class="text-center">Event Management</h2>
        
        <!-- Event Form -->
        <div class="card p-4 mt-3">
            <h4>Create Event</h4>
            <form id="eventForm">
                <div class="mb-3">
                    <label class="form-label">Event Name</label>
                    <input type="text" class="form-control" id="eventName" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="eventDescription"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-control" id="eventLocation" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Start Time</label>
                    <input type="datetime-local" class="form-control" id="eventStartTime" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">End Time</label>
                    <input type="datetime-local" class="form-control" id="eventEndTime" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Upload Image</label>
                    <input type="file" class="form-control" id="eventImage" accept="image/*">
                    <img id="imagePreview" class="img-thumbnail mt-2" style="display:none; max-width: 150px;">
                </div>
                <button type="submit" class="btn btn-primary">Create Event</button>
            </form>
            <p id="responseMessage"></p>
        </div>

        <!-- Events Table -->
        <h4 class="mt-5">All Events</h4>
        <table class="table table-bordered mt-3">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Event Name</th>
                    <th>Description</th>
                    <th>Location</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Image</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="eventTableBody"></tbody>
        </table>
    </div>

    <!-- Edit Event Modal -->
    <div class="modal fade" id="editEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editEventForm">
                        <input type="hidden" id="editEventId">
                        <div class="mb-3">
                            <label class="form-label">Event Name</label>
                            <input type="text" class="form-control" id="editEventName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editEventDescription"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="editEventLocation" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Time</label>
                            <input type="datetime-local" class="form-control" id="editEventStartTime" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">End Time</label>
                            <input type="datetime-local" class="form-control" id="editEventEndTime" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">created_by</label>
                            <input type="text" class="form-control" id="created_by" required>
                        </div>
                        <button type="submit" class="btn btn-success">Update Event</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script>
document.getElementById("eventImage").addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            document.getElementById("imagePreview").src = e.target.result;
            document.getElementById("imagePreview").style.display = "block";
        };
        reader.readAsDataURL(file);
    }
});

// Create Event
document.getElementById("eventForm").addEventListener("submit", async function (event) {
    event.preventDefault();
    
    const formData = new FormData();
    formData.append("name", document.getElementById("eventName").value);
    formData.append("description", document.getElementById("eventDescription").value);
    formData.append("location", document.getElementById("eventLocation").value);
    formData.append("start_time", document.getElementById("eventStartTime").value);
    formData.append("end_time", document.getElementById("eventEndTime").value);
    formData.append("image", document.getElementById("eventImage").files[0]);
    formData.append("created_by", document.getElementById("created_by").value);
    try {
        await axios.post("/api/event/", formData, { headers: { "Content-Type": "multipart/form-data" } });
        alert("Event created successfully!");
        document.getElementById("eventForm").reset();   
        loadEvents();
    } catch (error) {
        console.log(error);
        alert("Error creating event");
    }
});

// Load Events
async function loadEvents() {
    const response = await axios.get("/api/event/");
    const events = response.data;
    let rows = "";
    
    events.forEach(event => {
        rows += `
            <tr>
                <td>${event.id}</td>
                <td>${event.name}</td>
                <td>${event.description}</td>
                <td>${event.location}</td>
                <td>${event.start_time}</td>
                <td>${event.end_time}</td>
                <td><img src="${event.image}" width="50"></td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editEvent(${event.id})">Edit</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteEvent(${event.id})">Delete</button>
                </td>
            </tr>`;
    });
    document.getElementById("eventTableBody").innerHTML = rows;
}

// Delete Event
async function deleteEvent(id) {
    if (confirm("Are you sure?")) {
        await axios.delete(`/api/event/${id}`);
        loadEvents();
    }
}

// Edit Event
async function editEvent(id) {
    const response = await axios.get(`/api/event/${id}`);
    const event = response.data;
    document.getElementById("editEventId").value = event.id;
    document.getElementById("editEventName").value = event.name;
    document.getElementById("editEventDescription").value = event.description;
    document.getElementById("editEventLocation").value = event.location;
    document.getElementById("editEventStartTime").value = event.start_time;
    document.getElementById("editEventEndTime").value = event.end_time;
    
    new bootstrap.Modal(document.getElementById("editEventModal")).show();
}

document.addEventListener("DOMContentLoaded", loadEvents);
</script>

</body>
</html>
