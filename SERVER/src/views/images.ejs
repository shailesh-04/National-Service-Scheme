<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload & Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-[#141414] text-white p-5">
    <div class="max-w-4xl mx-auto bg-[#101a25] p-6 rounded-lg shadow-lg w-full">
        <h2 class="text-2xl font-bold text-center text-[#18f7b8]">Upload & Manage Images</h2>

        <!-- Upload Form -->
        <form id="uploadForm" class="mt-4 space-y-4">
            <input type="number" id="event_id" name="E_id" placeholder="Event ID"
                class="w-full p-2 bg-gray-800 text-white rounded" required>
            <input type="file" id="images" name="images" multiple class="w-full p-2 bg-gray-800 text-white rounded"
                accept="image/*" required>
            <button type="submit"
                class="w-full bg-[#18f7b8] text-black font-bold py-2 rounded hover:bg-[#0dcfa1] transition">Upload</button>
        </form>

        <!-- Image Gallery -->
        <h3 class="text-xl mt-6 text-center">Uploaded Images</h3>
        <div id="imageGallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const uploadForm = document.getElementById("uploadForm");
            const imageGallery = document.getElementById("imageGallery");

            // Fetch Images and Display in Gallery
            async function fetchImages() {
               
                try {
                    const response = await axios.get("/api/images");
                    imageGallery.innerHTML = "";
                    response.data.forEach(img => {
                        const div = document.createElement("div");
                        div.classList.add("relative", "bg-gray-900", "p-2", "rounded-lg", "shadow-md");
                        div.innerHTML = `
                            <img src="${img.imageurl}" class="w-full h-40 rounded-lg object-cover border-2 border-[#18f7b8]">
                            <div class="mt-2 flex flex-col space-y-2">
                                <span class="absolute top-0 left-0 bg-blue-100 text-[#00000088] p-3 rounded">${img.id}</span>
                                <input type="number" id="event_id${img.id}" name="E_id" placeholder="Event ID" class="w-full p-2 bg-gray-800 text-white rounded" required value="${img.E_id}">
                                <label class="border p-3 rounded flex items-center gap-2">
                                    <input type="checkbox" id="deleted${img.id}" ${img.is_deleted ? "checked" : ""}>
                                    Is Deleted
                                </label>
                                <input type="file" class="bg-gray-800 text-white p-1 rounded update-input" data-id="${img.id}">
                                <button class="bg-yellow-500 text-black px-3 py-1 rounded update-btn hover:bg-yellow-400 transition" data-id="${img.id}">Update</button>
                                <button class="bg-red-500 text-white px-3 py-1 rounded delete-btn hover:bg-red-400 transition" data-id="${img.id}" image="${img.imageurl}">Delete</button>
                            </div>
                        `;
                        imageGallery.appendChild(div);
                    });
                } catch (error) {
                    console.error("Error fetching images:", error);
                }
            }

            // Upload Images
            uploadForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(uploadForm);
                try {
                    await axios.post("/api/images", formData, {
                        headers: { "Content-Type": "multipart/form-data" },
                    }); 
                    fetchImages();
                } catch (error) {
                    console.error("Upload Error:", error);
                    alert("Failed to upload images.");
                }
            });

            // Update Image Functionality
            imageGallery.addEventListener("click", async (e) => {
                if (e.target.classList.contains("update-btn")) {
                    const id = e.target.getAttribute("data-id");
                    const fileInput = document.querySelector(`.update-input[data-id='${id}']`);

                    if (!fileInput.files.length) return alert("Please select an image!");

                    const formData = new FormData();
                    formData.append("image", fileInput.files[0]);
                    formData.append("is_deleted", document.querySelector(`#deleted${id}`).checked ? 1 : 0);
                    formData.append("E_id", document.querySelector(`#event_id${id}`).value);

                    try {
                        await axios.put(`/api/images/dashbord/${id}`, formData, {
                            headers: { "Content-Type": "multipart/form-data" },
                        });
                        alert("Image updated successfully!");
                        fetchImages();
                    } catch (error) {
                        console.error("Update Error:", error);
                        alert("Failed to update image.");
                    }
                }

                // Delete Image Functionality
                if (e.target.classList.contains("delete-btn")) {
                    const id = e.target.getAttribute("data-id");
                    const image = document.querySelector(".delete-btn").getAttribute("image");
                    if (confirm("Are you sure you want to delete this image?")) {
                        try {
                            await axios.post(`/api/images/${id}`,{image:image});
                            alert("Image deleted successfully!");
                            fetchImages();
                        } catch (error) {
                            console.error("Delete Error:", error);
                            alert("Failed to delete image.");
                        }
                    }
                }
            });

            // Initial Fetch
            fetchImages();
        });
    </script>
</body>

</html>
